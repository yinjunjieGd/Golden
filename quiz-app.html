<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åœ¨çº¿ç­”é¢˜åº”ç”¨</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      color: #213547;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      position: relative;
    }

    .home-button {
      position: fixed;
      top: 20px;
      left: 20px;
      width: 50px;
      height: 50px;
      background: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .home-button:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .home-button svg {
      width: 24px;
      height: 24px;
      fill: #667eea;
    }

    #app {
      max-width: 800px;
      margin: 0 auto;
    }

    .quiz-container {
      width: 100%;
    }

    .quiz-title {
      text-align: center;
      color: white;
      margin-bottom: 30px;
      font-size: 28px;
      font-weight: 600;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .question-card,
    .result-card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }

    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }

    .question-number {
      font-weight: 600;
      color: #666;
    }

    .score-display {
      font-weight: 600;
      color: #42b883;
    }

    .question-type-badge {
      display: inline-block;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .question-text {
      font-size: 20px;
      margin-bottom: 25px;
      color: #333;
      line-height: 1.5;
    }

    .options-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 30px;
    }

    .option-btn {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 15px 20px;
      text-align: left;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 16px;
      color: #495057;
      font-family: inherit;
    }

    .option-btn:hover:not(:disabled) {
      background: #e9ecef;
      border-color: #dee2e6;
      transform: translateY(-1px);
    }

    .option-btn.selected {
      background: #e3f2fd;
      border-color: #2196f3;
    }

    .option-btn.correct {
      background: #e8f5e9;
      border-color: #4caf50;
      color: #2e7d32;
    }

    .option-btn.incorrect {
      background: #ffebee;
      border-color: #f44336;
      color: #c62828;
    }

    .option-btn:disabled {
      cursor: not-allowed;
      opacity: 0.9;
    }

    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
    }

    .submit-btn,
    .next-btn,
    .restart-btn,
    .end-btn {
      padding: 12px 30px;
      font-size: 16px;
      font-weight: 500;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 120px;
      font-family: inherit;
    }

    .submit-btn {
      background: #2196f3;
      color: white;
    }

    .submit-btn:hover:not(:disabled) {
      background: #1976d2;
      transform: translateY(-1px);
    }

    .submit-btn:disabled {
      background: #bdbdbd;
      cursor: not-allowed;
    }

    .next-btn {
      background: #4caf50;
      color: white;
    }

    .next-btn:hover {
      background: #388e3c;
      transform: translateY(-1px);
    }

    .end-btn {
      background: #ff5252;
      color: white;
    }

    .end-btn:hover {
      background: #e53935;
      transform: translateY(-1px);
    }

    .result-card {
      text-align: center;
    }

    .result-title {
      color: #333;
      margin-bottom: 20px;
      font-size: 24px;
    }

    .final-score {
      font-size: 36px;
      font-weight: bold;
      color: #2196f3;
      margin-bottom: 20px;
    }

    .result-stats {
      margin-bottom: 30px;
      font-size: 16px;
      color: #666;
    }

    .result-stats p {
      margin: 8px 0;
    }

    .restart-btn {
      background: #ff9800;
      color: white;
    }

    .restart-btn:hover {
      background: #f57c00;
      transform: translateY(-1px);
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .question-card,
      .result-card {
        padding: 20px;
      }

      .quiz-title {
        font-size: 24px;
      }

      .question-text {
        font-size: 18px;
      }

      .option-btn {
        font-size: 15px;
        padding: 12px 15px;
      }
    }
  </style>
  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?407119d763a730fc49e032663c40363c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>
</head>
<body>
  <!-- è¿”å›æˆ‘çš„è¯¾ç¨‹æŒ‰é’® -->
  <button class="home-button" onclick="window.location.href='my-courses.html'" title="è¿”å›æˆ‘çš„è¯¾ç¨‹">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
    </svg>
  </button>
  
  <div id="app">
    <div class="quiz-container">
      <h1 class="quiz-title">åœ¨çº¿ç­”é¢˜ç³»ç»Ÿ</h1>
      
      <!-- é¡µé¢åŠ è½½æŒ‡ç¤º -->
      <div v-if="!mounted" style="text-align: center; padding: 40px;">
        <p style="font-size: 18px; color: #666;">é¡µé¢åŠ è½½ä¸­...</p>
      </div>
      
      <!-- ç©ºçŠ¶æ€æç¤º -->
      <div v-else-if="questions.length === 0" class="question-card" style="text-align: center; padding: 40px;">
        <h2 style="color: #666; margin-bottom: 20px;">æš‚æ— é¢˜ç›®æ•°æ®</h2>
        <p style="color: #999; margin-bottom: 10px;">è¯·ä»é¦–é¡µé€‰æ‹©è¯¾ç¨‹å¼€å§‹ç­”é¢˜</p>
        <p style="color: #999; font-size: 14px; margin-bottom: 20px;">ï¼ˆæç¤ºï¼šå¦‚æœæ‚¨åˆšä»é¦–é¡µè·³è½¬è¿‡æ¥ï¼Œè¯·å°è¯•åˆ·æ–°é¡µé¢ Ctrl+R æˆ– F5ï¼‰</p>
        <button class="submit-btn" style="margin-top: 20px;" onclick="window.location.href='/'">
          è¿”å›é¦–é¡µ
        </button>
      </div>
      
      <div v-else-if="currentQuestion" class="question-card">
        <div class="question-header">
          <span class="question-number">é—®é¢˜ {{ currentIndex + 1 }}/{{ questions.length }}</span>
          <span class="score-display">å¾—åˆ†: {{ score }}</span>
        </div>
        
        <div class="question-type-badge">
          {{ currentQuestion.type === 'single_choice' ? 'å•é€‰é¢˜' : 'å¤šé€‰é¢˜' }}
        </div>
        <h2 class="question-text">{{ currentQuestion.stem }}</h2>
        
        <div class="options-container">
          <button
            v-for="(value, key) in currentQuestion.options"
            :key="key"
            :class="[
              'option-btn',
              isOptionSelected(key) ? 'selected' : '',
              submitted ? (isCorrectOption(key) ? 'correct' : (isOptionSelected(key) ? 'incorrect' : '')) : ''
            ]"
            :disabled="submitted"
            @click="selectOption(key)"
          >
            {{ key }}. {{ value }}
          </button>
        </div>
        
        <div class="action-buttons">
          <button
            class="submit-btn"
            :disabled="submitted || selectedOption === null"
            @click="submitAnswer"
          >
            æäº¤ç­”æ¡ˆ
          </button>
          <button
            v-if="submitted && !isAutoSwitching"
            class="next-btn"
            @click="goToNextQuestion"
          >
            {{ currentIndex === questions.length - 1 ? 'å®Œæˆæµ‹éªŒ' : 'ä¸‹ä¸€é¢˜' }}
          </button>
        </div>
      </div>
      
      <div v-else-if="quizCompleted" class="result-card">
        <h2 class="result-title">æµ‹éªŒå®Œæˆ!</h2>
        <div class="final-score">
          ä½ çš„å¾—åˆ†: {{ score }}/{{ questions.length }}
        </div>
        <div class="result-stats">
          <p>æ­£ç¡®ç‡: {{ ((score / questions.length) * 100).toFixed(1) }}%</p>
          <p>ç”¨æ—¶: {{ timeSpent }} ç§’</p>
        </div>
        <button class="restart-btn" @click="restartQuiz">
          é‡æ–°å¼€å§‹
        </button>
      </div>
    </div>
  </div>

  <script>
    const { createApp, ref, computed, onMounted } = Vue

    createApp({
      setup() {
        // æ¥å£åœ°å€é…ç½® - ç¡¬ç¼–ç 
        const API_BASE_URL = 'https://pm-feel666service.gaodun.com';
        
        console.log('=== APIé…ç½®ä¿¡æ¯ ===');
        console.log('API_BASE_URL:', API_BASE_URL);
        console.log('==================');

        // ç”Ÿæˆè€ƒè¯•ID: userId + æ—¶é—´æˆ³ + éšæœºå­—ç¬¦ (ä¸è¶…è¿‡30å­—èŠ‚)
        const generateExamId = () => {
          const userId = 1;
          const timestamp = Date.now();
          const randomStr = Math.random().toString(36).substring(2, 8);
          const examId = `${userId}_${timestamp}_${randomStr}`;
          // ç¡®ä¿ä¸è¶…è¿‡30å­—èŠ‚
          return examId.substring(0, 30);
        };

        // å°†Dateå¯¹è±¡è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´çš„ISOå­—ç¬¦ä¸²ï¼ˆUTC+8ï¼‰
        const toBeijingTimeString = (date) => {
          // è·å–UTCæ—¶é—´çš„æ—¶é—´æˆ³
          const utcTime = date.getTime();
          // åŠ ä¸Š8å°æ—¶çš„æ¯«ç§’æ•°ï¼ˆ8 * 60 * 60 * 1000ï¼‰
          const beijingTime = new Date(utcTime + 8 * 60 * 60 * 1000);
          // è½¬æ¢ä¸ºISOå­—ç¬¦ä¸²ï¼Œä½†ä¿ç•™åŸæ—¶åŒºæ ‡è¯†
          return beijingTime.toISOString().replace('Z', '+08:00');
        };

        // åˆ›å»ºè€ƒè¯•è®°å½•
        const createExamRecord = async () => {
          console.log('ğŸ“ å¼€å§‹åˆ›å»ºè€ƒè¯•è®°å½•...');
          try {
            const examId = generateExamId();
            console.log('ç”Ÿæˆçš„examId:', examId);
            const now = new Date();
            const examName = `åœ¨çº¿ç­”é¢˜_${now.toLocaleString('zh-CN')}`;
            
            const requestData = {
              examId: examId,
              examName: examName,
              userId: 1,
              startTime: now.toISOString(),  // å…ˆå°è¯•ä½¿ç”¨æ ‡å‡†UTCæ ¼å¼
              status: 2  // é»˜è®¤çŠ¶æ€ä¸º2,è¡¨ç¤ºç­”é¢˜ä¸­
            };
            const createRecordUrl = `${API_BASE_URL}/api/answer-records/insert`;
            console.log('ğŸ“¡ [APIè°ƒç”¨] åˆ›å»ºè€ƒè¯•è®°å½•');
            console.log('è¯·æ±‚URL:', createRecordUrl);
            console.log('è¯·æ±‚æ•°æ®:', requestData);
            console.log('startTimeæ ¼å¼:', requestData.startTime);
            
            const response = await fetch(createRecordUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(requestData)
            });

            console.log('åˆ›å»ºè®°å½•å“åº”çŠ¶æ€:', response.status);
            if (response.ok) {
              const result = await response.json();
              console.log('âœ… è€ƒè¯•è®°å½•åˆ›å»ºæˆåŠŸ:', result);
              // ä¿å­˜è€ƒè¯•IDã€è®°å½•IDå’Œå¼€å§‹æ—¶é—´åˆ°sessionStorageï¼Œç”¨äºåç»­æ›´æ–°è®°å½•
              sessionStorage.setItem('currentExamId', examId);
              sessionStorage.setItem('examStartTime', now.getTime().toString()); // ä¿å­˜å¼€å§‹æ—¶é—´çš„æ—¶é—´æˆ³
              if (result.recordId) {
                sessionStorage.setItem('currentRecordId', result.recordId);
                console.log('âœ… recordIdå·²ä¿å­˜åˆ°sessionStorage:', result.recordId);
              }
              console.log('âœ… examIdå·²ä¿å­˜åˆ°sessionStorage:', examId);
              console.log('âœ… å¼€å§‹æ—¶é—´å·²ä¿å­˜åˆ°sessionStorage:', now.getTime());
              console.log('éªŒè¯sessionStorage:', sessionStorage.getItem('currentExamId'));
              return examId;
            } else {
              console.error('âŒ åˆ›å»ºè€ƒè¯•è®°å½•å¤±è´¥ï¼ŒçŠ¶æ€ç :', response.status);
              const errorText = await response.text();
              console.error('é”™è¯¯è¯¦æƒ…:', errorText);
            }
          } catch (error) {
            console.error('âŒ åˆ›å»ºè€ƒè¯•è®°å½•æ—¶å‘ç”Ÿé”™è¯¯:', error);
          }
        };

        // ä»URLè·å–courseIdå‚æ•°
        const getCourseIdFromUrl = () => {
          const urlParams = new URLSearchParams(window.location.search);
          const courseId = urlParams.get('courseId');
          console.log('ä»URLè·å–çš„courseId:', courseId);
          return courseId;
        };

        // ä»åç«¯APIè·å–é¢˜ç›®åˆ—è¡¨
        const fetchQuestions = async (courseId) => {
          try {
            console.log('ğŸ“¡ å¼€å§‹è·å–é¢˜ç›®åˆ—è¡¨, courseId:', courseId);
            const apiUrl = `${API_BASE_URL}/api/questions/getQuestionsByCourseId?courseId=${courseId}`;
            console.log('è¯·æ±‚URL:', apiUrl);
            
            const response = await fetch(apiUrl);
            console.log('å“åº”çŠ¶æ€:', response.status);
            
            if (response.ok) {
              const data = await response.json();
              console.log('âœ… é¢˜ç›®æ•°æ®è·å–æˆåŠŸ:', data);
              
              if (Array.isArray(data) && data.length > 0) {
                // æ ¼å¼åŒ–é¢˜ç›®æ•°æ®
                const formattedQuestions = data.map(q => ({
                  id: q.id || q.questionId,
                  questionId: q.id || q.questionId,
                  courseId: q.courseId || courseId,
                  type: q.type === 'single_choice' || q.type === 'å•é€‰é¢˜' ? 'single_choice' : 'multiple_choice',
                  stem: q.question || q.questionText || q.stem,
                  options: q.options || [],
                  correctAnswer: q.correctAnswer || q.answer
                }));
                console.log('æ ¼å¼åŒ–åçš„é¢˜ç›®:', formattedQuestions);
                return formattedQuestions;
              } else {
                console.warn('âš ï¸ è¿”å›çš„é¢˜ç›®æ•°æ®ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®');
                return [];
              }
            } else {
              console.error('âŒ è·å–é¢˜ç›®å¤±è´¥ï¼ŒçŠ¶æ€ç :', response.status);
              const errorText = await response.text();
              console.error('é”™è¯¯è¯¦æƒ…:', errorText);
              return [];
            }
          } catch (error) {
            console.error('âŒ è·å–é¢˜ç›®æ—¶å‘ç”Ÿé”™è¯¯:', error);
            return [];
          }
        };

        const questions = ref([]);
        const mounted = ref(false);

        const currentIndex = ref(0);
        // å•é€‰é¢˜ï¼šå­—ç¬¦ä¸²ï¼ˆå¦‚'A'ï¼‰ï¼›å¤šé€‰é¢˜ï¼šæ•°ç»„ï¼ˆå¦‚['A', 'B']ï¼‰
        const selectedOption = ref(null);
        const submitted = ref(false);
        const score = ref(0);
        const quizCompleted = ref(false);
        const startTime = ref(null);
        const timeSpent = ref(0);
        const isAutoSwitching = ref(false); // æ ‡è®°æ˜¯å¦æ­£åœ¨è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€é¢˜
        const questionStartTime = ref(null); // è®°å½•å½“å‰é¢˜ç›®çš„æ˜¾ç¤ºæ—¶é—´
        let timerInterval = null;

        // è®¡ç®—å½“å‰é—®é¢˜
        const currentQuestion = computed(() => {
          if (quizCompleted.value) return null;
          return questions.value[currentIndex.value];
        });

        // åˆ¤æ–­é€‰é¡¹æ˜¯å¦è¢«é€‰ä¸­
        const isOptionSelected = (key) => {
          if (currentQuestion.value.type === 'single_choice') {
            return selectedOption.value === key;
          } else {
            return Array.isArray(selectedOption.value) && selectedOption.value.includes(key);
          }
        };

        // åˆ¤æ–­é€‰é¡¹æ˜¯å¦æ˜¯æ­£ç¡®ç­”æ¡ˆ
        const isCorrectOption = (key) => {
          const correctAnswer = currentQuestion.value.correctAnswer;
          if (Array.isArray(correctAnswer)) {
            return correctAnswer.includes(key);
          } else {
            return correctAnswer === key;
          }
        };

        // å¼€å§‹è®¡æ—¶
        const startTimer = () => {
          startTime.value = Date.now();
          timerInterval = setInterval(() => {
            timeSpent.value = Math.floor((Date.now() - startTime.value) / 1000);
          }, 1000);
        };

        // åœæ­¢è®¡æ—¶
        const stopTimer = () => {
          if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
          }
        };

        // é€‰æ‹©ç­”æ¡ˆ
        const selectOption = (key) => {
          if (!submitted.value) {
            if (currentQuestion.value.type === 'single_choice') {
              // å•é€‰é¢˜ï¼šç›´æ¥è®¾ç½®é€‰ä¸­çš„é€‰é¡¹
              selectedOption.value = key;
            } else {
              // å¤šé€‰é¢˜ï¼šåˆ‡æ¢é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
              if (!Array.isArray(selectedOption.value)) {
                selectedOption.value = [];
              }
              const index = selectedOption.value.indexOf(key);
              if (index > -1) {
                selectedOption.value.splice(index, 1);
              } else {
                selectedOption.value.push(key);
              }
            }
          }
        };

        // æäº¤ç­”æ¡ˆ
        const submitAnswer = () => {
          if (selectedOption.value !== null && 
              (currentQuestion.value.type === 'single_choice' || 
               (Array.isArray(selectedOption.value) && selectedOption.value.length > 0))) {
            submitted.value = true;
            
            const correctAnswer = currentQuestion.value.correctAnswer;
            let isCorrect = false;
            
            if (currentQuestion.value.type === 'single_choice') {
              // å•é€‰é¢˜ï¼šç›´æ¥æ¯”è¾ƒ
              isCorrect = selectedOption.value === correctAnswer;
            } else {
              // å¤šé€‰é¢˜ï¼šæ‰€é€‰ç­”æ¡ˆä¸æ­£ç¡®ç­”æ¡ˆå®Œå…¨ä¸€è‡´
              const selected = Array.isArray(selectedOption.value) ? selectedOption.value.sort() : [];
              const correct = Array.isArray(correctAnswer) ? correctAnswer.sort() : [];
              isCorrect = JSON.stringify(selected) === JSON.stringify(correct);
            }
            
            if (isCorrect) {
              score.value++;
            }
            
            // è°ƒç”¨åç«¯æ¥å£åˆ›å»ºå•é¢˜è®°å½•
            createLearningRecord(isCorrect);
            
            // æ ‡è®°æ­£åœ¨è‡ªåŠ¨åˆ‡æ¢
            isAutoSwitching.value = true;
            
            // è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€é¢˜
            setTimeout(() => {
              isAutoSwitching.value = false;
              goToNextQuestion();
            }, 800); // å»¶è¿Ÿ800æ¯«ç§’ï¼Œè®©ç”¨æˆ·çœ‹åˆ°ç­”æ¡ˆåé¦ˆ
          }
        };

        // åˆ›å»ºå•é¢˜å­¦ä¹ è®°å½•
        const createLearningRecord = async (isCorrect) => {
          try {
            // è·å–å½“å‰é¢˜ç›®ä¿¡æ¯
            const question = currentQuestion.value;
            if (!question) {
              console.error('âŒ æœªæ‰¾åˆ°å½“å‰é¢˜ç›®ä¿¡æ¯');
              return;
            }
            
            // è®¡ç®—ç­”é¢˜æ¶ˆè€—æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œå››èˆäº”å…¥å–æ•´
            const answerTime = Date.now();
            const spendTime = questionStartTime.value ? 
              Math.round((answerTime - questionStartTime.value) / 1000) : 0;
            
            // è·å–ç”¨æˆ·ç­”æ¡ˆ
            let userAnswer = '';
            if (question.type === 'single_choice') {
              userAnswer = selectedOption.value || '';
            } else {
              userAnswer = Array.isArray(selectedOption.value) ? 
                selectedOption.value.join(',') : '';
            }
            
            // æ„é€ è¯·æ±‚æ•°æ®
            const recordData = {
              userId: 1, // å½“å‰ç”¨æˆ·IDï¼Œéœ€è¦ä»å®é™…ç™»å½•ä¿¡æ¯è·å–
              questionId: question.id || question.questionId, // é¢˜ç›®ID
              courseId: question.courseId || null, // è¯¾ç¨‹ID
              userAnswer: userAnswer,
              isCorrect: isCorrect,
              answeredAt: new Date(answerTime).toISOString(),
              timeSpent: spendTime,
              answerId: sessionStorage.getItem('currentRecordId') || null // ç­”é¢˜è®°å½•ID
            };
            
            console.log('ğŸ“ åˆ›å»ºå•é¢˜å­¦ä¹ è®°å½•:', recordData);
            
            const response = await fetch(`${API_BASE_URL}/api/user-learning-records/insert`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(recordData)
            });
            
            if (response.ok) {
              const result = await response.json();
              console.log('âœ… å•é¢˜å­¦ä¹ è®°å½•åˆ›å»ºæˆåŠŸ:', result);
            } else {
              console.error('âŒ åˆ›å»ºå•é¢˜å­¦ä¹ è®°å½•å¤±è´¥ï¼ŒçŠ¶æ€ç :', response.status);
              const errorText = await response.text();
              console.error('é”™è¯¯è¯¦æƒ…:', errorText);
            }
          } catch (error) {
            console.error('âŒ åˆ›å»ºå•é¢˜å­¦ä¹ è®°å½•æ—¶å‘ç”Ÿé”™è¯¯:', error);
          }
        };
        
        // æ›´æ–°ç­”é¢˜è®°å½•
        const updateExamRecord = async () => {
          console.log('ğŸ“ å¼€å§‹æ›´æ–°ç­”é¢˜è®°å½•...');
          try {
            const examId = sessionStorage.getItem('currentExamId');
            const recordId = sessionStorage.getItem('currentRecordId');
            const startTimeStr = sessionStorage.getItem('examStartTime');
            console.log('ä»sessionStorageè·å–çš„examId:', examId);
            console.log('ä»sessionStorageè·å–çš„recordId:', recordId);
            console.log('ä»sessionStorageè·å–çš„å¼€å§‹æ—¶é—´:', startTimeStr);
            
            if (!examId || !recordId) {
              console.error('âŒ æœªæ‰¾åˆ°è€ƒè¯•IDæˆ–è®°å½•IDï¼Œæ— æ³•æ›´æ–°ç­”é¢˜è®°å½•');
              console.log('sessionStorageå†…å®¹:', sessionStorage);
              return;
            }

            const now = new Date();
            const endTime = now.getTime();
            
            // è®¡ç®—ç­”é¢˜æ¶ˆè€—æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œå››èˆäº”å…¥å–æ•´
            let timeSpent = 0;
            if (startTimeStr) {
              const startTime = parseInt(startTimeStr);
              timeSpent = Math.round((endTime - startTime) / 1000); // è½¬æ¢ä¸ºç§’å¹¶å››èˆäº”å…¥
              console.log('è®¡ç®—timeSpent: å¼€å§‹æ—¶é—´=', startTime, ', ç»“æŸæ—¶é—´=', endTime, ', æ¶ˆè€—æ—¶é—´(ç§’)=', timeSpent);
            } else {
              console.warn('âš ï¸ æœªæ‰¾åˆ°å¼€å§‹æ—¶é—´ï¼ŒtimeSpentå°†è®¾ä¸º0');
            }
            
            const updateData = {
              recordId: recordId,
              examId: examId,
              userId: 1,
              endTime: toBeijingTimeString(now),
              score: score.value,
              totalQuestions: questions.value.length,
              timeSpent: timeSpent,  // æ·»åŠ æ¶ˆè€—æ—¶é—´å­—æ®µ
              status: 1  // 1è¡¨ç¤ºå·²å®Œæˆ
            };
            const updateRecordUrl = `${API_BASE_URL}/api/answer-records/update`;
            console.log('ğŸ“¡ [APIè°ƒç”¨] æ›´æ–°ç­”é¢˜è®°å½•');
            console.log('è¯·æ±‚URL:', updateRecordUrl);
            console.log('è¯·æ±‚æ•°æ®:', updateData);
            
            const response = await fetch(updateRecordUrl, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(updateData)
            });

            console.log('æ›´æ–°è®°å½•å“åº”çŠ¶æ€:', response.status);
            if (response.ok) {
              const result = await response.json();
              console.log('âœ… ç­”é¢˜è®°å½•æ›´æ–°æˆåŠŸ:', result);
            } else {
              console.error('âŒ æ›´æ–°ç­”é¢˜è®°å½•å¤±è´¥ï¼ŒçŠ¶æ€ç :', response.status);
              const errorText = await response.text();
              console.error('é”™è¯¯è¯¦æƒ…:', errorText);
            }
          } catch (error) {
            console.error('âŒ æ›´æ–°ç­”é¢˜è®°å½•æ—¶å‘ç”Ÿé”™è¯¯:', error);
          }
        };

        // ä¸‹ä¸€é¢˜
        const goToNextQuestion = () => {
          if (currentIndex.value < questions.value.length - 1) {
            currentIndex.value++;
            // æ ¹æ®ä¸‹ä¸€é¢˜çš„ç±»å‹åˆå§‹åŒ–selectedOption
            const nextQuestion = questions.value[currentIndex.value];
            selectedOption.value = nextQuestion.type === 'multiple_choice' ? [] : null;
            submitted.value = false;
            // è®°å½•æ–°é¢˜ç›®çš„æ˜¾ç¤ºæ—¶é—´
            questionStartTime.value = Date.now();
          } else {
            // å®Œæˆæµ‹éªŒ
            console.log('ğŸ‰ ç­”é¢˜å®Œæˆ,å‡†å¤‡è°ƒç”¨æ›´æ–°æ¥å£');
            stopTimer();
            quizCompleted.value = true;
            // æ›´æ–°ç­”é¢˜è®°å½•
            console.log('å³å°†è°ƒç”¨updateExamRecordå‡½æ•°');
            updateExamRecord();
            console.log('updateExamRecordå‡½æ•°å·²è°ƒç”¨');
          }
        };

        // é‡æ–°å¼€å§‹
        const restartQuiz = () => {
          currentIndex.value = 0;
          // æ ¹æ®ç¬¬ä¸€é¢˜çš„ç±»å‹åˆå§‹åŒ–selectedOption
          selectedOption.value = questions.value.length > 0 && questions.value[0].type === 'multiple_choice' ? [] : null;
          submitted.value = false;
          score.value = 0;
          quizCompleted.value = false;
          timeSpent.value = 0;
          startTimer();
        };

        // å¼€å§‹è®¡æ—¶
        startTimer();

        // æ¸…ç†å®šæ—¶å™¨
        window.addEventListener('beforeunload', stopTimer);

        // ç»„ä»¶æŒ‚è½½å®Œæˆ
        onMounted(async () => {
          console.log('ğŸš€ Vueåº”ç”¨å·²æŒ‚è½½');
          
          // ä»URLè·å–courseIdå¹¶åŠ è½½é¢˜ç›®
          const courseId = getCourseIdFromUrl();
          if (courseId) {
            console.log('å‡†å¤‡åŠ è½½è¯¾ç¨‹é¢˜ç›®, courseId:', courseId);
            const loadedQuestions = await fetchQuestions(courseId);
            questions.value = loadedQuestions;
            console.log('é¢˜ç›®åŠ è½½å®Œæˆï¼Œæ•°é‡:', questions.value.length);
            
            // åˆå§‹åŒ–selectedOption
            if (questions.value.length > 0) {
              selectedOption.value = questions.value[0].type === 'multiple_choice' ? [] : null;
              // è®°å½•ç¬¬ä¸€é¢˜çš„æ˜¾ç¤ºæ—¶é—´
              questionStartTime.value = Date.now();
            }
          } else {
            console.warn('âš ï¸ URLä¸­æœªæ‰¾åˆ°courseIdå‚æ•°');
          }
          
          // æ•°æ®åŠ è½½å®Œæˆåè®¾ç½®mountedæ ‡å¿—
          mounted.value = true;
          
          // åˆ›å»ºè€ƒè¯•è®°å½•
          createExamRecord();
        });

        return {
          questions,
          mounted,
          currentIndex,
          selectedOption,
          submitted,
          score,
          quizCompleted,
          timeSpent,
          isAutoSwitching,
          currentQuestion,
          selectOption,
          submitAnswer,
          goToNextQuestion,
          restartQuiz,
          isOptionSelected,
          isCorrectOption
        }
      }
    }).mount('#app')
  </script>
</body>
</html>