<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>在线答题应用</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      color: #213547;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      position: relative;
    }

    .home-button {
      position: fixed;
      top: 20px;
      left: 20px;
      width: 50px;
      height: 50px;
      background: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .home-button:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .home-button svg {
      width: 24px;
      height: 24px;
      fill: #667eea;
    }

    #app {
      max-width: 800px;
      margin: 0 auto;
    }

    .quiz-container {
      width: 100%;
    }

    .quiz-title {
      text-align: center;
      color: white;
      margin-bottom: 30px;
      font-size: 28px;
      font-weight: 600;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .question-card,
    .result-card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }

    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }

    .question-number {
      font-weight: 600;
      color: #666;
    }

    .score-display {
      font-weight: 600;
      color: #42b883;
    }

    .question-type-badge {
      display: inline-block;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .question-text {
      font-size: 20px;
      margin-bottom: 25px;
      color: #333;
      line-height: 1.5;
    }

    .options-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 30px;
    }

    .option-btn {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 15px 20px;
      text-align: left;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 16px;
      color: #495057;
      font-family: inherit;
    }

    .option-btn:hover:not(:disabled) {
      background: #e9ecef;
      border-color: #dee2e6;
      transform: translateY(-1px);
    }

    .option-btn.selected {
      background: #e3f2fd;
      border-color: #2196f3;
    }

    .option-btn.correct {
      background: #e8f5e9;
      border-color: #4caf50;
      color: #2e7d32;
    }

    .option-btn.incorrect {
      background: #ffebee;
      border-color: #f44336;
      color: #c62828;
    }

    .option-btn:disabled {
      cursor: not-allowed;
      opacity: 0.9;
    }

    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
    }

    .submit-btn,
    .next-btn,
    .restart-btn,
    .end-btn {
      padding: 12px 30px;
      font-size: 16px;
      font-weight: 500;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 120px;
      font-family: inherit;
    }

    .submit-btn {
      background: #2196f3;
      color: white;
    }

    .submit-btn:hover:not(:disabled) {
      background: #1976d2;
      transform: translateY(-1px);
    }

    .submit-btn:disabled {
      background: #bdbdbd;
      cursor: not-allowed;
    }

    .next-btn {
      background: #4caf50;
      color: white;
    }

    .next-btn:hover {
      background: #388e3c;
      transform: translateY(-1px);
    }

    .end-btn {
      background: #ff5252;
      color: white;
    }

    .end-btn:hover {
      background: #e53935;
      transform: translateY(-1px);
    }

    .result-card {
      text-align: center;
    }

    .result-title {
      color: #333;
      margin-bottom: 20px;
      font-size: 24px;
    }

    .final-score {
      font-size: 36px;
      font-weight: bold;
      color: #2196f3;
      margin-bottom: 20px;
    }

    .result-stats {
      margin-bottom: 30px;
      font-size: 16px;
      color: #666;
    }

    .result-stats p {
      margin: 8px 0;
    }

    .restart-btn {
      background: #ff9800;
      color: white;
    }

    .restart-btn:hover {
      background: #f57c00;
      transform: translateY(-1px);
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .question-card,
      .result-card {
        padding: 20px;
      }

      .quiz-title {
        font-size: 24px;
      }

      .question-text {
        font-size: 18px;
      }

      .option-btn {
        font-size: 15px;
        padding: 12px 15px;
      }
    }
  </style>
  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?407119d763a730fc49e032663c40363c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>
</head>
<body>
  <!-- 返回我的课程按钮 -->
  <button class="home-button" onclick="window.location.href='my-courses.html'" title="返回我的课程">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
    </svg>
  </button>
  
  <div id="app">
    <div class="quiz-container">
      <h1 class="quiz-title">在线答题系统</h1>
      
      <!-- 页面加载指示 -->
      <div v-if="!mounted" style="text-align: center; padding: 40px;">
        <p style="font-size: 18px; color: #666;">页面加载中...</p>
      </div>
      
      <!-- 空状态提示 -->
      <div v-else-if="questions.length === 0" class="question-card" style="text-align: center; padding: 40px;">
        <h2 style="color: #666; margin-bottom: 20px;">暂无题目数据</h2>
        <p style="color: #999; margin-bottom: 10px;">请从首页选择课程开始答题</p>
        <p style="color: #999; font-size: 14px; margin-bottom: 20px;">（提示：如果您刚从首页跳转过来，请尝试刷新页面 Ctrl+R 或 F5）</p>
        <button class="submit-btn" style="margin-top: 20px;" onclick="window.location.href='/'">
          返回首页
        </button>
      </div>
      
      <div v-else-if="currentQuestion" class="question-card">
        <div class="question-header">
          <span class="question-number">问题 {{ currentIndex + 1 }}/{{ questions.length }}</span>
          <span class="score-display">得分: {{ score }}</span>
        </div>
        
        <div class="question-type-badge">
          {{ currentQuestion.type === 'single_choice' ? '单选题' : '多选题' }}
        </div>
        <h2 class="question-text">{{ currentQuestion.stem }}</h2>
        
        <div class="options-container">
          <button
            v-for="(value, key) in currentQuestion.options"
            :key="key"
            :class="[
              'option-btn',
              isOptionSelected(key) ? 'selected' : '',
              submitted ? (isCorrectOption(key) ? 'correct' : (isOptionSelected(key) ? 'incorrect' : '')) : ''
            ]"
            :disabled="submitted"
            @click="selectOption(key)"
          >
            {{ key }}. {{ value }}
          </button>
        </div>
        
        <div class="action-buttons">
          <button
            class="submit-btn"
            :disabled="submitted || selectedOption === null"
            @click="submitAnswer"
          >
            提交答案
          </button>
          <button
            v-if="submitted && !isAutoSwitching"
            class="next-btn"
            @click="goToNextQuestion"
          >
            {{ currentIndex === questions.length - 1 ? '完成测验' : '下一题' }}
          </button>
        </div>
      </div>
      
      <div v-else-if="quizCompleted" class="result-card">
        <h2 class="result-title">测验完成!</h2>
        <div class="final-score">
          你的得分: {{ score }}/{{ questions.length }}
        </div>
        <div class="result-stats">
          <p>正确率: {{ ((score / questions.length) * 100).toFixed(1) }}%</p>
          <p>用时: {{ timeSpent }} 秒</p>
        </div>
        <button class="restart-btn" @click="restartQuiz">
          重新开始
        </button>
      </div>
    </div>
  </div>

  <script>
    const { createApp, ref, computed, onMounted } = Vue

    createApp({
      setup() {
        // 接口地址配置 - 硬编码
        const API_BASE_URL = 'https://pm-feel666service.gaodun.com';
        
        console.log('=== API配置信息 ===');
        console.log('API_BASE_URL:', API_BASE_URL);
        console.log('==================');

        // 生成考试ID: userId + 时间戳 + 随机字符 (不超过30字节)
        const generateExamId = () => {
          const userId = 1;
          const timestamp = Date.now();
          const randomStr = Math.random().toString(36).substring(2, 8);
          const examId = `${userId}_${timestamp}_${randomStr}`;
          // 确保不超过30字节
          return examId.substring(0, 30);
        };

        // 将Date对象转换为北京时间的ISO字符串（UTC+8）
        const toBeijingTimeString = (date) => {
          // 获取UTC时间的时间戳
          const utcTime = date.getTime();
          // 加上8小时的毫秒数（8 * 60 * 60 * 1000）
          const beijingTime = new Date(utcTime + 8 * 60 * 60 * 1000);
          // 转换为ISO字符串，但保留原时区标识
          return beijingTime.toISOString().replace('Z', '+08:00');
        };

        // 创建考试记录
        const createExamRecord = async () => {
          console.log('📝 开始创建考试记录...');
          try {
            const examId = generateExamId();
            console.log('生成的examId:', examId);
            const now = new Date();
            const examName = `在线答题_${now.toLocaleString('zh-CN')}`;
            
            const requestData = {
              examId: examId,
              examName: examName,
              userId: 1,
              startTime: now.toISOString(),  // 先尝试使用标准UTC格式
              status: 2  // 默认状态为2,表示答题中
            };
            const createRecordUrl = `${API_BASE_URL}/api/answer-records/insert`;
            console.log('📡 [API调用] 创建考试记录');
            console.log('请求URL:', createRecordUrl);
            console.log('请求数据:', requestData);
            console.log('startTime格式:', requestData.startTime);
            
            const response = await fetch(createRecordUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(requestData)
            });

            console.log('创建记录响应状态:', response.status);
            if (response.ok) {
              const result = await response.json();
              console.log('✅ 考试记录创建成功:', result);
              // 保存考试ID、记录ID和开始时间到sessionStorage，用于后续更新记录
              sessionStorage.setItem('currentExamId', examId);
              sessionStorage.setItem('examStartTime', now.getTime().toString()); // 保存开始时间的时间戳
              if (result.recordId) {
                sessionStorage.setItem('currentRecordId', result.recordId);
                console.log('✅ recordId已保存到sessionStorage:', result.recordId);
              }
              console.log('✅ examId已保存到sessionStorage:', examId);
              console.log('✅ 开始时间已保存到sessionStorage:', now.getTime());
              console.log('验证sessionStorage:', sessionStorage.getItem('currentExamId'));
              return examId;
            } else {
              console.error('❌ 创建考试记录失败，状态码:', response.status);
              const errorText = await response.text();
              console.error('错误详情:', errorText);
            }
          } catch (error) {
            console.error('❌ 创建考试记录时发生错误:', error);
          }
        };

        // 从URL获取courseId参数
        const getCourseIdFromUrl = () => {
          const urlParams = new URLSearchParams(window.location.search);
          const courseId = urlParams.get('courseId');
          console.log('从URL获取的courseId:', courseId);
          return courseId;
        };

        // 从后端API获取题目列表
        const fetchQuestions = async (courseId) => {
          try {
            console.log('📡 开始获取题目列表, courseId:', courseId);
            const apiUrl = `${API_BASE_URL}/api/questions/getQuestionsByCourseId?courseId=${courseId}`;
            console.log('请求URL:', apiUrl);
            
            const response = await fetch(apiUrl);
            console.log('响应状态:', response.status);
            
            if (response.ok) {
              const data = await response.json();
              console.log('✅ 题目数据获取成功:', data);
              
              if (Array.isArray(data) && data.length > 0) {
                // 格式化题目数据
                const formattedQuestions = data.map(q => ({
                  id: q.id || q.questionId,
                  questionId: q.id || q.questionId,
                  courseId: q.courseId || courseId,
                  type: q.type === 'single_choice' || q.type === '单选题' ? 'single_choice' : 'multiple_choice',
                  stem: q.question || q.questionText || q.stem,
                  options: q.options || [],
                  correctAnswer: q.correctAnswer || q.answer
                }));
                console.log('格式化后的题目:', formattedQuestions);
                return formattedQuestions;
              } else {
                console.warn('⚠️ 返回的题目数据为空或格式不正确');
                return [];
              }
            } else {
              console.error('❌ 获取题目失败，状态码:', response.status);
              const errorText = await response.text();
              console.error('错误详情:', errorText);
              return [];
            }
          } catch (error) {
            console.error('❌ 获取题目时发生错误:', error);
            return [];
          }
        };

        const questions = ref([]);
        const mounted = ref(false);

        const currentIndex = ref(0);
        // 单选题：字符串（如'A'）；多选题：数组（如['A', 'B']）
        const selectedOption = ref(null);
        const submitted = ref(false);
        const score = ref(0);
        const quizCompleted = ref(false);
        const startTime = ref(null);
        const timeSpent = ref(0);
        const isAutoSwitching = ref(false); // 标记是否正在自动切换到下一题
        const questionStartTime = ref(null); // 记录当前题目的显示时间
        let timerInterval = null;

        // 计算当前问题
        const currentQuestion = computed(() => {
          if (quizCompleted.value) return null;
          return questions.value[currentIndex.value];
        });

        // 判断选项是否被选中
        const isOptionSelected = (key) => {
          if (currentQuestion.value.type === 'single_choice') {
            return selectedOption.value === key;
          } else {
            return Array.isArray(selectedOption.value) && selectedOption.value.includes(key);
          }
        };

        // 判断选项是否是正确答案
        const isCorrectOption = (key) => {
          const correctAnswer = currentQuestion.value.correctAnswer;
          if (Array.isArray(correctAnswer)) {
            return correctAnswer.includes(key);
          } else {
            return correctAnswer === key;
          }
        };

        // 开始计时
        const startTimer = () => {
          startTime.value = Date.now();
          timerInterval = setInterval(() => {
            timeSpent.value = Math.floor((Date.now() - startTime.value) / 1000);
          }, 1000);
        };

        // 停止计时
        const stopTimer = () => {
          if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
          }
        };

        // 选择答案
        const selectOption = (key) => {
          if (!submitted.value) {
            if (currentQuestion.value.type === 'single_choice') {
              // 单选题：直接设置选中的选项
              selectedOption.value = key;
            } else {
              // 多选题：切换选项的选中状态
              if (!Array.isArray(selectedOption.value)) {
                selectedOption.value = [];
              }
              const index = selectedOption.value.indexOf(key);
              if (index > -1) {
                selectedOption.value.splice(index, 1);
              } else {
                selectedOption.value.push(key);
              }
            }
          }
        };

        // 提交答案
        const submitAnswer = () => {
          if (selectedOption.value !== null && 
              (currentQuestion.value.type === 'single_choice' || 
               (Array.isArray(selectedOption.value) && selectedOption.value.length > 0))) {
            submitted.value = true;
            
            const correctAnswer = currentQuestion.value.correctAnswer;
            let isCorrect = false;
            
            if (currentQuestion.value.type === 'single_choice') {
              // 单选题：直接比较
              isCorrect = selectedOption.value === correctAnswer;
            } else {
              // 多选题：所选答案与正确答案完全一致
              const selected = Array.isArray(selectedOption.value) ? selectedOption.value.sort() : [];
              const correct = Array.isArray(correctAnswer) ? correctAnswer.sort() : [];
              isCorrect = JSON.stringify(selected) === JSON.stringify(correct);
            }
            
            if (isCorrect) {
              score.value++;
            }
            
            // 调用后端接口创建单题记录
            createLearningRecord(isCorrect);
            
            // 标记正在自动切换
            isAutoSwitching.value = true;
            
            // 自动切换到下一题
            setTimeout(() => {
              isAutoSwitching.value = false;
              goToNextQuestion();
            }, 800); // 延迟800毫秒，让用户看到答案反馈
          }
        };

        // 创建单题学习记录
        const createLearningRecord = async (isCorrect) => {
          try {
            // 获取当前题目信息
            const question = currentQuestion.value;
            if (!question) {
              console.error('❌ 未找到当前题目信息');
              return;
            }
            
            // 计算答题消耗时间（秒），四舍五入取整
            const answerTime = Date.now();
            const spendTime = questionStartTime.value ? 
              Math.round((answerTime - questionStartTime.value) / 1000) : 0;
            
            // 获取用户答案
            let userAnswer = '';
            if (question.type === 'single_choice') {
              userAnswer = selectedOption.value || '';
            } else {
              userAnswer = Array.isArray(selectedOption.value) ? 
                selectedOption.value.join(',') : '';
            }
            
            // 构造请求数据
            const recordData = {
              userId: 1, // 当前用户ID，需要从实际登录信息获取
              questionId: question.id || question.questionId, // 题目ID
              courseId: question.courseId || null, // 课程ID
              userAnswer: userAnswer,
              isCorrect: isCorrect,
              answeredAt: new Date(answerTime).toISOString(),
              timeSpent: spendTime,
              answerId: sessionStorage.getItem('currentRecordId') || null // 答题记录ID
            };
            
            console.log('📝 创建单题学习记录:', recordData);
            
            const response = await fetch(`${API_BASE_URL}/api/user-learning-records/insert`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(recordData)
            });
            
            if (response.ok) {
              const result = await response.json();
              console.log('✅ 单题学习记录创建成功:', result);
            } else {
              console.error('❌ 创建单题学习记录失败，状态码:', response.status);
              const errorText = await response.text();
              console.error('错误详情:', errorText);
            }
          } catch (error) {
            console.error('❌ 创建单题学习记录时发生错误:', error);
          }
        };
        
        // 更新答题记录
        const updateExamRecord = async () => {
          console.log('📝 开始更新答题记录...');
          try {
            const examId = sessionStorage.getItem('currentExamId');
            const recordId = sessionStorage.getItem('currentRecordId');
            const startTimeStr = sessionStorage.getItem('examStartTime');
            console.log('从sessionStorage获取的examId:', examId);
            console.log('从sessionStorage获取的recordId:', recordId);
            console.log('从sessionStorage获取的开始时间:', startTimeStr);
            
            if (!examId || !recordId) {
              console.error('❌ 未找到考试ID或记录ID，无法更新答题记录');
              console.log('sessionStorage内容:', sessionStorage);
              return;
            }

            const now = new Date();
            const endTime = now.getTime();
            
            // 计算答题消耗时间（秒），四舍五入取整
            let timeSpent = 0;
            if (startTimeStr) {
              const startTime = parseInt(startTimeStr);
              timeSpent = Math.round((endTime - startTime) / 1000); // 转换为秒并四舍五入
              console.log('计算timeSpent: 开始时间=', startTime, ', 结束时间=', endTime, ', 消耗时间(秒)=', timeSpent);
            } else {
              console.warn('⚠️ 未找到开始时间，timeSpent将设为0');
            }
            
            const updateData = {
              recordId: recordId,
              examId: examId,
              userId: 1,
              endTime: toBeijingTimeString(now),
              score: score.value,
              totalQuestions: questions.value.length,
              timeSpent: timeSpent,  // 添加消耗时间字段
              status: 1  // 1表示已完成
            };
            const updateRecordUrl = `${API_BASE_URL}/api/answer-records/update`;
            console.log('📡 [API调用] 更新答题记录');
            console.log('请求URL:', updateRecordUrl);
            console.log('请求数据:', updateData);
            
            const response = await fetch(updateRecordUrl, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(updateData)
            });

            console.log('更新记录响应状态:', response.status);
            if (response.ok) {
              const result = await response.json();
              console.log('✅ 答题记录更新成功:', result);
            } else {
              console.error('❌ 更新答题记录失败，状态码:', response.status);
              const errorText = await response.text();
              console.error('错误详情:', errorText);
            }
          } catch (error) {
            console.error('❌ 更新答题记录时发生错误:', error);
          }
        };

        // 下一题
        const goToNextQuestion = () => {
          if (currentIndex.value < questions.value.length - 1) {
            currentIndex.value++;
            // 根据下一题的类型初始化selectedOption
            const nextQuestion = questions.value[currentIndex.value];
            selectedOption.value = nextQuestion.type === 'multiple_choice' ? [] : null;
            submitted.value = false;
            // 记录新题目的显示时间
            questionStartTime.value = Date.now();
          } else {
            // 完成测验
            console.log('🎉 答题完成,准备调用更新接口');
            stopTimer();
            quizCompleted.value = true;
            // 更新答题记录
            console.log('即将调用updateExamRecord函数');
            updateExamRecord();
            console.log('updateExamRecord函数已调用');
          }
        };

        // 重新开始
        const restartQuiz = () => {
          currentIndex.value = 0;
          // 根据第一题的类型初始化selectedOption
          selectedOption.value = questions.value.length > 0 && questions.value[0].type === 'multiple_choice' ? [] : null;
          submitted.value = false;
          score.value = 0;
          quizCompleted.value = false;
          timeSpent.value = 0;
          startTimer();
        };

        // 开始计时
        startTimer();

        // 清理定时器
        window.addEventListener('beforeunload', stopTimer);

        // 组件挂载完成
        onMounted(async () => {
          console.log('🚀 Vue应用已挂载');
          
          // 从URL获取courseId并加载题目
          const courseId = getCourseIdFromUrl();
          if (courseId) {
            console.log('准备加载课程题目, courseId:', courseId);
            const loadedQuestions = await fetchQuestions(courseId);
            questions.value = loadedQuestions;
            console.log('题目加载完成，数量:', questions.value.length);
            
            // 初始化selectedOption
            if (questions.value.length > 0) {
              selectedOption.value = questions.value[0].type === 'multiple_choice' ? [] : null;
              // 记录第一题的显示时间
              questionStartTime.value = Date.now();
            }
          } else {
            console.warn('⚠️ URL中未找到courseId参数');
          }
          
          // 数据加载完成后设置mounted标志
          mounted.value = true;
          
          // 创建考试记录
          createExamRecord();
        });

        return {
          questions,
          mounted,
          currentIndex,
          selectedOption,
          submitted,
          score,
          quizCompleted,
          timeSpent,
          isAutoSwitching,
          currentQuestion,
          selectOption,
          submitAnswer,
          goToNextQuestion,
          restartQuiz,
          isOptionSelected,
          isCorrectOption
        }
      }
    }).mount('#app')
  </script>
</body>
</html>